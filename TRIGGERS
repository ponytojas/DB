
/* TRIGGER PARA CALCULO DE PUNTOS */

CREATE OR REPLACE FUNCTION FN_PUNTOS_GANADOS() RETURNS TRIGGER AS $FN_PUNTOS_GANADOS$
    BEGIN 
    UPDATE COMPRA
	SET COMPRA.PUNTOS_GANADOS = new.compra.precio_entrada * 0.1
	FROM 
	WHERE new.compra.id_compra = compra.id_compra;
    RETURN NULL;
    END;

$FN_PUNTOS_GANADOS$ LANGUAGE PLPGSQL;


CREATE TRIGGER TG_PUNTOS_GANADOS BEFORE INSERT OR UPDATE ON COMPRA
FOR EACH ROW 

EXECUTE PROCEDURE FN_PUNTOS_GANADOS();

CREATE OR REPLACE FUNCTION FN_PUNTOS_GASTADOS() RETURNS TRIGGER AS $FN_PUNTOS_GASTADOS$
    DECLARE
    PUNTOS_GASTADOS_COMPRA = 0.05 * PRECIO_ENTRADA.PRECIO_ENTRADA WHERE PRECIO_ENTRADA.ID_ENTRADA = COMPRA_ENTRADA.ID_ENTRADA 
    AND COMPRA_ENTRADA.ID_COMPRA = COMPRA.ID_COMPRA; 

    BEGIN 
    INSERT INTO COMPRA VALUES (PUNTOS_GASTADOS_COMPRA);
    RETURN NULL;
    END;

$FN_PUNTOS_GASTADOS$ LANGUAGE PLPGSQL;

CREATE TRIGGER TG_PUNTOS_GASTADOS BEFORE INSERT OR UPDATE ON COMPRAS 
FOR EACH ROW 

EXECUTE PROCEDURE FN_PUNTOS_GASTADOS();




